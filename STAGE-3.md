# Работа с данными в таблицах

На третьем этапе реализуем:
1) Добавление данных в таблицу
2) Чтение данных из таблицы
3) Обновление данных в таблице
4) Удаление данных из таблицы

Все результирующие таблички, образовавшиеся в результате выполнения команды небходимо
возвращать из ручки, аналогичным образом, как это делается в командах из предыдущей
части задания. Т.е. должна присутсвовать схема, и данные.

## Добавление данных в таблицу

```sql
INSERT INTO table_name (column1_name, column2_name, ..., columnN_name)
VALUES
    (1, true, ..., 'str_value1'),
    (2, true, ..., 'str_value2'),
    ...,
    (100, false, ..., 'str_value100')
RETURNING column1_name, column5_name;
```
Команда INSERT INTO добавляет данные в таблицу "table_name", после имени таблицы,
в круглых скобках, указаны имена колонок, значения для которых мы будем указывать далее.
Если при создании таблицы для каких-то колонок были указаны значения по умолчанию
при помощи ключевого слова DEFAULT, то такая колонка может быть опущена при добавлении
данных в таблицу, в этом случае необходимо использовать это самое значение по умолчанию.
Так же нельзя указывать колонку, которая имеет тип SERIAL, т.к. значение этой колонки
должно назначаться автоматически при добавлении.

Часть запроса с ключевым словом RETURNING являетмя не обязательной и указывает на то какие
колонки мы будем возвращать в результате выполнения запроса, рассмотрим пример:

Есть таблица "tab1", в которой есть поле "id" с типом SERIAL, поле "name" с типом STRING и поле
"is_ready" с типом BOOLEAN, допустим для поля "is_ready" задано значение по умолчанию FALSE,
а счетчик для поля id был равен, допустим 100 на момент начала выполнения запроса, тогда в
результате выполнения запроса:

```sql
INSERT INTO tab1 (name)
VALUES ('n1'), ('n2'), ('n3')
RETURNING id, is_ready
```

Мы должны получить табличку вида:

```
------------------
| id  | is_ready |
------------------
| 100 | false    |
| 101 | false    |
| 102 | false    |
------------------
```

Если же RETURNING отсутствует, то в качестве результата используется пустая таблица,
без колонок и строк в ней.

При добавлении данных в таблицу следует учитывать важный случай.
В ситуациях когда в таблице есть PRIMARY KEY поле, например
со STRING типом, и мы пытаемся добавить в таблицу запись, в которой уже есть другая
запись с таким же значением. То мы должны вернуть ошибку 409 (Conflict), т.к. данные
которые мы передали конфликтуют с теми, что уже в таблице.

## Чтение данных из таблицы

```sql
SELECT column1_name, column2_name, ..., columnN_name FROM table_name
WHERE column1_name > 10
ORDER BY column2_name ASC
LIMIT 10
```
Добавлю еще несколько примеров корректных запросов:
```sql
SELECT * FROM table_name;
SELECT column_name FROM table_name WHERE id < 10;
SELECT column_name FROM table_name LIMIT 10;
SELECT column_name FROM table_name ORDER BY column_name DESC;
```
Итак чтобы получить какие-то данные из таблицы используется команда SELECT FROM.
После ключевого слова SELECT идет список имен колонок, которые мы хотим получить из таблицы.
Если вместо списка указан символ *, тогда выбираются все колонки. После списка обязательно идет
ключевое слово FROM, после него имя таблицы. На этом обязательная часть запроса заканчивается.
Все остальные ключевые слова являются не обязательными и могут отсутствовать.

Ключевое слово WHERE задает условие на значение колонки. Возвращаются только те строки
таблицы, которые удовлетворяют условию. В реальной жизни условие может содержать сложные
выражения, например:
```sql
WHERE column1_name > 10 AND (column2_name = 'abc' OR column3_name = true)
```
Мы же сделаем допущение и будем поддерживать только условие по одной колонке и будем
поддерживать только следующий набор операторов =, !=, >, <, >= и <=.
При сравнении строк используем Ordinal - сравнение. Колонка с типом SERIAL в выражении сравнения
интерпретируется как INTEGER. Если условие не задано, то возвращаются все строки.

Ключевое слово ORDER BY задает сортировку результата по значению колонки, имя которой идет
после ORDER BY. Так же после имени колонки необходимо указать направление сортировки
ASC - задает восходящую (от меньшего значения к большему), DESC - задает нисходящую.
Если сортировка не задана, строки возвращаются в порядке их размещения в таблице.

Ключевое слово LIMIT 10 ограничивает количество строк, которые будут возвращены в результате.
Если ограничение не задается, возвращаются все подходящие строки.

## Обновление данных в таблице

```sql
UPDATE table_name
SET
    column1_name = 'some str value',
    column2_name = DEFAULT
WHERE
    column3_name != 123
RETURNING
    column4_name
```

Команда UPDATE обновляет все строки в таблице "table_name", подходящие под условие заданное в WHERE.
Если условие не задано, тогда обновляются вообще все строки. После ключевого слова SET
указывается список колонок с их новыми значениями. Если в качестве значения указано
ключевое слово DEFAULT, тогда используется значение по умолчанию, которое было задано при
создании таблицы. Если же значение по умолчанию не задано для колонки, тогда - это ошибка и необходимо
вернуть код ошибки 400. Как и при любых других ошибках, найденных при парсинге SQL запроса.

Ключевое слово RETURNING, как и в других командах, является не обязательным, и задает список колонок
которые необходимо вернуть в результирующей табличке. Если среди возвращаемых колонок
присутствует колонка, которую мы обновляем (указана в секции SET), тогда должно возвращаться
ее новое значение.

## Удаление данных из таблицы

```sql
DELETE FROM table_name
WHERE column1_name = 'value'
RETURNING id;
```

Чтобы удалить данные из таблицы в SQL используют команду DELETE FROM. У данной команды
так же есть необязательная часть WHERE, задающая условие на удаляемые записи, а также
RETURNING которое позволяет задать список колонок, которые должен вернуть запрос.
В результат данной команды попадают те строки, которые запрос удаляет. Если ключевое
слово WHERE не указано, то удалются все строки из таблицы. Если не указано ключевое слово
RETURNING, возвращаем пустую таблицу. Так же важной особенностью данной команды является
то, что она не изменяет значение счетчиков (в нашем случае единственного возможного поля
с типом SERIAL). Т.е. если в таблицу были добавлены записи и допустим SERIAL счетчик,
для последней строки был 10, после чего мы удалили все строки из таблицы, и добавили новую
строку, то счетчик для нее будет равен 11.
